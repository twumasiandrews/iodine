/*
 * Copyright (c) 2017 Frekk van Blagh <frekk@frekkworks.com>
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include <check.h>
#include <unistd.h>
#include <stdint.h>
#include <time.h>
#include <stdio.h>
#include <err.h>
#include <string.h>
#include <stdlib.h>

#include "common.h"
#include "test.h"

#include "md5.h"
#include "hmac_md5.h"

/* test HMAC-MD5 to RFC 2202
 * code adapted from public domain, courtesy of
 * Tom St Denis, tomstdenis@gmail.com, http://libtomcrypt.com
 * src/mac/hmac/hmac_test.c */
START_TEST(test_hmac_md5)
{
	uint8_t digest[MD5_HASHSIZE];
	int i;
	static struct hmac_test_case {
		int num;
		char *algo;
		uint8_t key[128];
		size_t keylen;
		uint8_t data[128];
		size_t datalen;
		uint8_t digest[MD5_HASHSIZE];
	} cases[] = {
		/* 2. Test Cases for HMAC-MD5
		test_case =     1
		key =           0x0b 0b 0b 0b
						  0b 0b 0b 0b
						  0b 0b 0b 0b
						  0b 0b 0b 0b
		key_len =       16
		data =          "Hi There"
		data_len =      8
		digest =        0x92 94 72 7a
						  36 38 bb 1c
						  13 f4 8e f8
						  15 8b fc 9d
		*/
		{ 1, "md5",
			{0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
			 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b}, 16,
			"Hi There", 8,
			{0x92, 0x94, 0x72, 0x7a, 0x36, 0x38, 0xbb, 0x1c,
			 0x13, 0xf4, 0x8e, 0xf8, 0x15, 0x8b, 0xfc, 0x9d}  },
		/*
		test_case =     2
		key =           "Jefe"
		key_len =       4
		data =          "what do ya want for nothing?"
		data_len =      28
		digest =        0x750c783e6ab0b503eaa86e310a5db738
		*/
		{ 2, "md5",
			"Jefe", 4,
			"what do ya want for nothing?", 28,
			{0x75, 0x0c, 0x78, 0x3e, 0x6a, 0xb0, 0xb5, 0x03,
			 0xea, 0xa8, 0x6e, 0x31, 0x0a, 0x5d, 0xb7, 0x38} },
		/*
		test_case =     3
		key =           0xaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
		key_len         16
		data =          0xdd repeated 50 times
		data_len =      50
		digest =        0x56be34521d144c88dbb8c733f0e8b3f6
		*/
		{ 3, "md5",
			{0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa}, 16,
			{0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
			 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
			 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
			 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
			 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd}, 50,
			{0x56, 0xbe, 0x34, 0x52, 0x1d, 0x14, 0x4c, 0x88,
			 0xdb, 0xb8, 0xc7, 0x33, 0xf0, 0xe8, 0xb3, 0xf6} },
		/*
		test_case =     4
		key = 0x0102030405060708090a0b0c0d0e0f10111213141516171819
		key_len         25
		data =          0xcd repeated 50 times
		data_len =      50
		digest =        0x697eaf0aca3a3aea3a75164746ffaa79
		*/
		{ 4, "md5",
			{0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a,
			 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14,
			 0x15, 0x16, 0x17, 0x18, 0x19}, 25,
			{0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
			 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
			 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
			 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
			 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd}, 50,
			{0x69, 0x7e, 0xaf, 0x0a, 0xca, 0x3a, 0x3a, 0xea,
			 0x3a, 0x75, 0x16, 0x47, 0x46, 0xff, 0xaa, 0x79} },
		/*

		test_case =     5
		key =           0x0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c
		key_len =       16
		data =          "Test With Truncation"
		data_len =      20
		digest =        0x56461ef2342edc00f9bab995690efd4c
		digest-96       0x56461ef2342edc00f9bab995
		*/
		{ 5, "md5",
			{0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c,
			 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c}, 16,
			"Test With Truncation", 20,
			{0x56, 0x46, 0x1e, 0xf2, 0x34, 0x2e, 0xdc, 0x00,
			 0xf9, 0xba, 0xb9, 0x95, 0x69, 0x0e, 0xfd, 0x4c} },
		/*
		test_case =     6
		key =           0xaa repeated 80 times
		key_len =       80
		data =          "Test Using Larger Than Block-Size Key - Hash
Key First"
		data_len =      54
		digest =        0x6b1ab7fe4bd7bf8f0b62e6ce61b9d0cd
		*/
		{ 6, "md5",
			{0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,

			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa}, 80,
			"Test Using Larger Than Block-Size Key - Hash Key First", 54,
			{0x6b, 0x1a, 0xb7, 0xfe, 0x4b, 0xd7, 0xbf, 0x8f,
			 0x0b, 0x62, 0xe6, 0xce, 0x61, 0xb9, 0xd0, 0xcd} },
		/*
		test_case =     7
		key =           0xaa repeated 80 times
		key_len =       80
		data =          "Test Using Larger Than Block-Size Key and Larger
						Than One Block-Size Data"
		data_len =      73
		digest =        0x6f630fad67cda0ee1fb1f562db3aa53e
		*/
		{ 7, "md5",
			{0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
			 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa}, 80,
			"Test Using Larger Than Block-Size Key and Larger Than One Block-Size Data", 73,
			{0x6f, 0x63, 0x0f, 0xad, 0x67, 0xcd, 0xa0, 0xee,
			 0x1f, 0xb1, 0xf5, 0x62, 0xdb, 0x3a, 0xa5, 0x3e} }
	};
	/* end test cases */

	for(i=0; i < (int)(sizeof(cases) / sizeof(cases[0])); i++) {
		hmac_md5(digest, cases[i].key, cases[i].keylen,cases[i].data, cases[i].datalen);
#if 0
		unsigned int j;
		fprintf(stderr, "\nHMAC-%s test #%d:\n", cases[i].algo, cases[i].num);
		fprintf(stderr,   "Result:  0x");
		for(j=0; j < MD5_HASHSIZE; j++) {
			fprintf(stderr, "%02x", digest[j]);
		}
		fprintf(stderr, "\nCorrect: 0x");
		for(j=0; j < MD5_HASHSIZE; j++) {
		   fprintf(stderr, "%02x", cases[i].digest[j]);
		}
		fprintf(stderr, "\n");
#endif
		fail_if(memcmp(digest, cases[i].digest, MD5_HASHSIZE) != 0,
				"HMAC_MD5 failed: digest was incorrect!");
	}
}
END_TEST


TCase *
test_hmac_create_tests()
{
	TCase *tc;

	tc = tcase_create("HMAC");
	tcase_add_test(tc, test_hmac_md5);

	return tc;
}
